<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Sorsone</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <h2>Sorsone Admin</h2>
            </div>
            <ul class="nav-menu" id="navMenu">
                <li><a href="index.html">Home</a></li>
                <li><a href="dashboard.html" class="active">Dashboard</a></li>
            </ul>
            <div class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Dashboard Header -->
    <section class="dashboard-header">
        <div class="container">
            <h1>üìä Admin Dashboard</h1>
            <p>Overview of all orders and performance metrics</p>
        </div>
    </section>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card fade-in">
            <div class="stat-icon">üì¶</div>
            <div class="stat-value" id="totalOrders">0</div>
            <div class="stat-label">Total Orders</div>
        </div>
        <div class="stat-card fade-in">
            <div class="stat-icon">üí∞</div>
            <div class="stat-value" id="totalRevenue">‚Çπ0</div>
            <div class="stat-label">Total Revenue</div>
        </div>
        <div class="stat-card fade-in">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-value" id="paidOrders">0</div>
            <div class="stat-label">Paid Orders</div>
        </div>
        <div class="stat-card fade-in">
            <div class="stat-icon">‚è≥</div>
            <div class="stat-value" id="pendingOrders">0</div>
            <div class="stat-label">Pending Payments</div>
        </div>
        <div class="stat-card fade-in">
            <div class="stat-icon">üë•</div>
            <div class="stat-value" id="totalCustomers">0</div>
            <div class="stat-label">Total Customers</div>
        </div>
        <div class="stat-card fade-in">
            <div class="stat-icon">üìß</div>
            <div class="stat-value" id="totalContacts">0</div>
            <div class="stat-label">Contact Leads</div>
        </div>
    </div>

    <!-- Orders Table -->
    <section class="section section-light">
        <div class="container">
            <div class="orders-table-wrapper">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                    <h2 style="color: var(--primary-green);">Recent Orders</h2>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <select id="paymentFilter" style="padding: 0.5rem 1rem; border: 2px solid var(--primary-green); border-radius: 25px; background: white; cursor: pointer;">
                            <option value="all">All Payments</option>
                            <option value="paid">Paid</option>
                            <option value="pending">Pending</option>
                        </select>
                        <select id="methodFilter" style="padding: 0.5rem 1rem; border: 2px solid var(--primary-green); border-radius: 25px; background: white; cursor: pointer;">
                            <option value="all">All Methods</option>
                            <option value="cod">COD</option>
                            <option value="razorpay">Online</option>
                        </select>
                        <button onclick="loadDashboardData()" class="btn btn-primary" style="padding: 0.5rem 1.5rem;">
                            üîÑ Refresh Data
                        </button>
                    </div>
                </div>
                
                <div id="loadingMessage" class="loading">
                    <p>Loading dashboard data...</p>
                </div>
                
                <div id="ordersTableContainer" style="display: none; overflow-x: auto;">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Phone</th>
                                <th>Product</th>
                                <th>Color</th>
                                <th>Qty</th>
                                <th>Amount</th>
                                <th>Payment Method</th>
                                <th>Payment Status</th>
                                <th>Transaction ID</th>
                                <th>Order Status</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Orders will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="noDataMessage" style="display: none; text-align: center; padding: 3rem; color: var(--text-light);">
                    <p>No orders found. Orders will appear here once customers start placing orders.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Contact Leads Table -->
    <section class="section section-white">
        <div class="container">
            <div class="orders-table-wrapper">
                <h2 style="color: var(--primary-green); margin-bottom: 1.5rem;">Contact Form Submissions</h2>
                
                <div id="contactsTableContainer" style="display: none; overflow-x: auto;">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Subject</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody id="contactsTableBody">
                            <!-- Contacts will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="noContactsMessage" style="display: none; text-align: center; padding: 3rem; color: var(--text-light);">
                    <p>No contact submissions yet.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <h3>Sorsone Admin</h3>
                    <p>Dashboard for managing orders and customer data</p>
                </div>
                <div class="footer-links">
                    <div class="footer-column">
                        <h4>Quick Links</h4>
                        <ul>
                            <li><a href="index.html">Home</a></li>
                            <li><a href="dashboard.html">Dashboard</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 Sorsone.com - Admin Dashboard</p>
            </div>
        </div>
    </footer>

    <script src="js/script.js"></script>
    <script>
        // ==================== DASHBOARD LOGIC - UPDATED VERSION ====================
        // Enhanced with COD support, better statistics, and auto-refresh
        
        let dashboardData = {
            orders: [],
            contacts: [],
            filteredOrders: []
        };

        // Track last order count for new order notifications
        let lastOrderCount = 0;

        /**
         * Format date for display in Indian format
         */
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            }) + ' ' + date.toLocaleTimeString('en-IN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        /**
         * Format currency in Indian format
         */
        function formatCurrency(amount) {
            return `‚Çπ${amount.toLocaleString('en-IN')}`;
        }

        /**
         * Apply filters to orders based on payment status and method
         * UPDATED: Better COD handling
         */
        function applyFilters() {
            const paymentFilter = document.getElementById('paymentFilter').value;
            const methodFilter = document.getElementById('methodFilter').value;
            
            dashboardData.filteredOrders = dashboardData.orders.filter(order => {
                const paymentStatus = (order.paymentStatus || 'pending').toLowerCase();
                const paymentMethod = (order.paymentMethod || 'cod').toLowerCase();
                
                // Payment status filter
                let paymentMatch = false;
                if (paymentFilter === 'all') {
                    paymentMatch = true;
                } else if (paymentFilter === 'paid') {
                    paymentMatch = paymentStatus === 'paid';
                } else if (paymentFilter === 'pending') {
                    // ‚úÖ UPDATED: Pending includes both 'pending' and 'cod'
                    paymentMatch = paymentStatus === 'pending' || paymentStatus === 'cod';
                }
                
                // Payment method filter
                let methodMatch = false;
                if (methodFilter === 'all') {
                    methodMatch = true;
                } else if (methodFilter === 'cod') {
                    // ‚úÖ UPDATED: Better COD detection
                    methodMatch = paymentMethod.includes('cod') || paymentMethod.includes('cash');
                } else if (methodFilter === 'razorpay') {
                    // ‚úÖ UPDATED: Better online payment detection
                    methodMatch = paymentMethod.includes('online') || paymentMethod.includes('razorpay');
                }
                
                return paymentMatch && methodMatch;
            });
            
            displayOrders();
        }

        /**
         * Load dashboard data from backend
         * Fetches both orders and contacts
         */
        async function loadDashboardData() {
            const loadingMessage = document.getElementById('loadingMessage');
            const ordersContainer = document.getElementById('ordersTableContainer');
            const noDataMessage = document.getElementById('noDataMessage');
            const contactsContainer = document.getElementById('contactsTableContainer');
            const noContactsMessage = document.getElementById('noContactsMessage');
            
            loadingMessage.style.display = 'block';
            ordersContainer.style.display = 'none';
            noDataMessage.style.display = 'none';
            contactsContainer.style.display = 'none';
            noContactsMessage.style.display = 'none';
            
            try {
                // Fetch orders data
                const ordersResponse = await fetch(`${CONFIG.BACKEND_URL}?action=getOrders`);
                if (!ordersResponse.ok) {
                    throw new Error('Failed to fetch orders');
                }
                const ordersResult = await ordersResponse.json();
                
                // Fetch contacts data
                const contactsResponse = await fetch(`${CONFIG.BACKEND_URL}?action=getContacts`);
                if (!contactsResponse.ok) {
                    throw new Error('Failed to fetch contacts');
                }
                const contactsResult = await contactsResponse.json();
                
                dashboardData.orders = ordersResult.data || [];
                dashboardData.contacts = contactsResult.data || [];
                dashboardData.filteredOrders = dashboardData.orders;
                
                // ‚úÖ NEW: Check for new orders and show notification
                checkForNewOrders();
                
                // Update statistics
                updateStatistics();
                
                // Display orders table
                if (dashboardData.orders.length > 0) {
                    displayOrders();
                    ordersContainer.style.display = 'block';
                } else {
                    noDataMessage.style.display = 'block';
                }
                
                // Display contacts table
                if (dashboardData.contacts.length > 0) {
                    displayContacts();
                    contactsContainer.style.display = 'block';
                } else {
                    noContactsMessage.style.display = 'block';
                }
                
                loadingMessage.style.display = 'none';
            } catch (error) {
                console.error('Dashboard load error:', error);
                loadingMessage.innerHTML = '<p style="color: var(--red);">Failed to load data. Please check your backend URL in js/script.js</p>';
            }
        }

        /**
         * Update statistics cards
         * UPDATED: Better revenue calculation (only PAID orders)
         */
        function updateStatistics() {
            // Total orders
            const totalOrders = dashboardData.orders.length;
            document.getElementById('totalOrders').textContent = totalOrders;
            
            // ‚úÖ UPDATED: Calculate statistics properly
            let totalRevenue = 0;
            let paidOrders = 0;
            let pendingOrders = 0;
            let codOrders = 0;
            
            dashboardData.orders.forEach(order => {
                const paymentStatus = (order.paymentStatus || 'pending').toLowerCase();
                const amount = parseFloat(order.totalAmount) || 0;
                
                if (paymentStatus === 'paid') {
                    paidOrders++;
                    totalRevenue += amount; // ‚úÖ Only count revenue from PAID orders
                } else if (paymentStatus === 'cod') {
                    codOrders++;
                } else {
                    pendingOrders++;
                }
            });
            
            // Update UI
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('paidOrders').textContent = paidOrders;
            // ‚úÖ UPDATED: Pending includes both pending online and COD orders
            document.getElementById('pendingOrders').textContent = pendingOrders + codOrders;
            
            // Total unique customers
            const uniqueCustomers = new Set(dashboardData.orders.map(order => order.phone)).size;
            document.getElementById('totalCustomers').textContent = uniqueCustomers;
            
            // Total contacts
            document.getElementById('totalContacts').textContent = dashboardData.contacts.length;
        }

        /**
         * Display orders in table
         * UPDATED: Better payment status display for COD
         */
        function displayOrders() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';
            
            // Sort orders by date (newest first)
            const sortedOrders = [...dashboardData.filteredOrders].sort((a, b) => {
                return new Date(b.orderDate) - new Date(a.orderDate);
            });
            
            sortedOrders.forEach(order => {
                const paymentStatus = (order.paymentStatus || 'pending').toLowerCase();
                const paymentMethod = (order.paymentMethod || 'COD');
                const orderStatus = (order.orderStatus || 'pending').toLowerCase();
                
                // ‚úÖ UPDATED: Determine payment status color and text properly
                let paymentBadgeClass = 'status-pending';
                let paymentStatusText = 'PENDING';
                
                if (paymentStatus === 'paid') {
                    paymentBadgeClass = 'status-paid';
                    paymentStatusText = 'PAID';
                } else if (paymentStatus === 'cod') {
                    paymentBadgeClass = 'status-cod';
                    paymentStatusText = 'COD';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${order.orderId || 'N/A'}</strong></td>
                    <td>${formatDate(order.orderDate)}</td>
                    <td>${order.customerName}</td>
                    <td>${order.phone}</td>
                    <td>${order.productName}</td>
                    <td style="text-transform: capitalize;">${order.colorVariant}</td>
                    <td>${order.quantity}</td>
                    <td><strong>${formatCurrency(order.totalAmount)}</strong></td>
                    <td><span class="badge badge-method">${paymentMethod}</span></td>
                    <td><span class="status-badge ${paymentBadgeClass}">${paymentStatusText}</span></td>
                    <td style="font-size: 0.85rem; color: var(--text-light);">
                        ${order.razorpayPaymentId ? order.razorpayPaymentId.substring(0, 15) + '...' : '-'}
                    </td>
                    <td><span class="status-badge status-${orderStatus}">${orderStatus.toUpperCase()}</span></td>
                `;
                tbody.appendChild(row);
            });
            
            // Update "no data" message if filtered results are empty
            const noDataMessage = document.getElementById('noDataMessage');
            if (sortedOrders.length === 0 && dashboardData.orders.length > 0) {
                noDataMessage.innerHTML = '<p>No orders match the selected filters.</p>';
                noDataMessage.style.display = 'block';
                document.getElementById('ordersTableContainer').style.display = 'none';
            }
        }

        /**
         * Display contacts in table
         */
        function displayContacts() {
            const tbody = document.getElementById('contactsTableBody');
            tbody.innerHTML = '';
            
            // Sort contacts by date (newest first)
            const sortedContacts = [...dashboardData.contacts].sort((a, b) => {
                return new Date(b.submittedAt) - new Date(a.submittedAt);
            });
            
            sortedContacts.forEach(contact => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(contact.submittedAt)}</td>
                    <td>${contact.name}</td>
                    <td>${contact.email}</td>
                    <td>${contact.phone || 'N/A'}</td>
                    <td>${contact.subject}</td>
                    <td style="max-width: 300px; word-wrap: break-word;">${contact.message}</td>
                `;
                tbody.appendChild(row);
            });
        }

        /**
         * ‚úÖ NEW FUNCTION: Check for new orders and show notification
         */
        function checkForNewOrders() {
            if (dashboardData.orders.length > lastOrderCount && lastOrderCount > 0) {
                const newOrdersCount = dashboardData.orders.length - lastOrderCount;
                showNotification(`üéâ ${newOrdersCount} new order(s) received!`);
            }
            lastOrderCount = dashboardData.orders.length;
        }

        /**
         * ‚úÖ NEW FUNCTION: Show notification for new orders
         */
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: var(--primary-green);
                color: white;
                padding: 1rem 2rem;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease;
                font-weight: 600;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Add filter event listeners
        document.getElementById('paymentFilter').addEventListener('change', applyFilters);
        document.getElementById('methodFilter').addEventListener('change', applyFilters);

        // ‚úÖ UPDATED: Load data when page loads and set up auto-refresh
        window.addEventListener('load', () => {
            loadDashboardData();
            
            // Auto-refresh every 30 seconds
            setInterval(loadDashboardData, 30000);
        });

        // ‚úÖ NEW: Add CSS for notifications and COD status badge
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
            .status-cod {
                background: #fff3cd;
                color: #856404;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>