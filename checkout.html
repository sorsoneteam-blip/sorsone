// ===== CONFIGURATION =====
const RAZORPAY_KEY_ID = 'rzp_live_S7dLsK39ZbKgt2';
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbziQ18oMXJKdJwFwPUANb-TX0ryqd2K3b6wvfaVnt7Yf16Qp7qfVN4Nw-GqVomB9ynY6A/exec';

// Pricing structure
let pricing = {
    1: { original: 1299, offer: 299, discount: 1000 },
    2: { original: 2598, offer: 499, discount: 2099 },
    3: { original: 3897, offer: 799, discount: 3098 }
};

// ===== CREATE ORDER IN BACKEND =====
async function createOrder(formData) {
    try {
        const response = await fetch(BACKEND_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'create_order',
                ...formData
            })
        });

        // Check if response is OK
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.success) {
            return result;
        } else {
            throw new Error(result.error || 'Failed to create order');
        }
    } catch (error) {
        console.error('Backend error:', error);
        
        // Fallback: Generate order ID locally if backend fails
        const timestamp = new Date().getTime();
        const random = Math.floor(Math.random() * 10000);
        const orderId = `ORD-${timestamp}-${random}`;

        return {
            success: true,
            orderId: orderId,
            timestamp: new Date().toISOString()
        };
    }
}

// ===== HANDLE PAYMENT =====
async function handlePayment() {
    console.log('Payment button clicked');
    
    if (!validateForm()) {
        return;
    }

    const cart = JSON.parse(localStorage.getItem('sorsoneCart')) || [];
    if (cart.length === 0) {
        showAlert('Your cart is empty', 'error');
        return;
    }

    const paymentButton = document.getElementById('paymentButton');
    const loadingSpinner = document.getElementById('loadingSpinner');

    paymentButton.disabled = true;
    loadingSpinner.classList.add('active');

    try {
        // Get form data
        const formData = getFormData();
        
        // Create order in backend
        const orderData = await createOrder(formData);
        
        console.log('Order created:', orderData);
        
        if (!orderData.success) {
            throw new Error(orderData.error || 'Failed to create order');
        }

        // Initialize Razorpay payment
        initiateRazorpayPayment(orderData, formData);

    } catch (error) {
        console.error('Payment error:', error);
        showAlert('Payment initialization failed: ' + error.message, 'error');
        paymentButton.disabled = false;
        loadingSpinner.classList.remove('active');
    }
}

// ===== INITIATE RAZORPAY PAYMENT =====
function initiateRazorpayPayment(orderData, formData) {
    console.log('Initiating Razorpay payment...');
    
    const totalQuantity = formData.totalItems;
    const priceData = pricing[totalQuantity] || pricing[3];

    const options = {
        key: RAZORPAY_KEY_ID,
        amount: priceData.offer * 100, // Amount in paise
        currency: 'INR',
        name: 'SORSONE',
        description: `Order for ${totalQuantity} Premium T-Shirt${totalQuantity > 1 ? 's' : ''}`,
        image: 'images/favicon.jpg',
        handler: function(response) {
            handlePaymentSuccess(response, orderData, formData);
        },
        prefill: {
            name: formData.fullName,
            email: formData.email,
            contact: formData.phone
        },
        notes: {
            order_id: orderData.orderId,
            address: `${formData.address1}, ${formData.city}, ${formData.state}`
        },
        theme: {
            color: '#D32F2F'
        },
        modal: {
            ondismiss: function() {
                document.getElementById('paymentButton').disabled = false;
                document.getElementById('loadingSpinner').classList.remove('active');
            }
        }
    };

    try {
        const rzp = new Razorpay(options);
        
        rzp.on('payment.failed', function(response) {
            handlePaymentFailure(response);
        });

        rzp.open();
        
        // Hide loading spinner after modal opens
        setTimeout(() => {
            document.getElementById('loadingSpinner').classList.remove('active');
        }, 500);
        
    } catch (error) {
        console.error('Razorpay error:', error);
        showAlert('Failed to open payment window. Please try again.', 'error');
        document.getElementById('paymentButton').disabled = false;
        document.getElementById('loadingSpinner').classList.remove('active');
    }
}

// ===== HANDLE PAYMENT SUCCESS =====
async function handlePaymentSuccess(razorpayResponse, orderData, formData) {
    try {
        console.log('Payment successful:', razorpayResponse);
        
        // Save order data to backend
        await fetch(BACKEND_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'save_customer',
                orderId: orderData.orderId,
                razorpayOrderId: razorpayResponse.razorpay_order_id || '',
                razorpayPaymentId: razorpayResponse.razorpay_payment_id || '',
                razorpaySignature: razorpayResponse.razorpay_signature || '',
                ...formData,
                status: 'success',
                timestamp: new Date().toISOString()
            })
        });

        // Clear cart
        localStorage.removeItem('sorsoneCart');

        // Redirect to success page
        window.location.href = `Paymentsuccess.html?order_id=${orderData.orderId}&payment_id=${razorpayResponse.razorpay_payment_id}`;

    } catch (error) {
        console.error('Error saving order:', error);
        // Even if saving fails, redirect to success page
        localStorage.removeItem('sorsoneCart');
        window.location.href = `Paymentsuccess.html?order_id=${orderData.orderId}&payment_id=${razorpayResponse.razorpay_payment_id || 'N/A'}`;
    }
}

// ===== VALIDATE FORM =====
function validateForm() {
    const form = document.getElementById('checkoutForm');
    const termsAccept = document.getElementById('termsAccept');

    if (!form.checkValidity()) {
        form.reportValidity();
        return false;
    }

    if (!termsAccept.checked) {
        showAlert('Please accept the Terms & Conditions', 'error');
        return false;
    }

    return true;
}

// ===== GET FORM DATA =====
function getFormData() {
    const cart = JSON.parse(localStorage.getItem('sorsoneCart')) || [];
    const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
    const priceData = pricing[totalQuantity] || pricing[3];

    return {
        fullName: document.getElementById('fullName').value.trim(),
        email: document.getElementById('email').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        address1: document.getElementById('address1').value.trim(),
        address2: document.getElementById('address2').value.trim(),
        city: document.getElementById('city').value.trim(),
        state: document.getElementById('state').value,
        pincode: document.getElementById('pincode').value.trim(),
        country: document.getElementById('country').value,
        instructions: document.getElementById('instructions').value.trim(),
        items: cart,
        totalItems: totalQuantity,
        totalAmount: priceData.offer
    };
}

// ===== SHOW ALERT =====
function showAlert(message, type) {
    const formAlert = document.getElementById('formAlert');
    formAlert.textContent = message;
    formAlert.className = `alert ${type} active`;
    
    setTimeout(() => {
        formAlert.classList.remove('active');
    }, 5000);

    formAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// ===== HANDLE PAYMENT FAILURE =====
function handlePaymentFailure(response) {
    const paymentButton = document.getElementById('paymentButton');
    const loadingSpinner = document.getElementById('loadingSpinner');
    
    paymentButton.disabled = false;
    loadingSpinner.classList.remove('active');

    console.error('Payment failed:', response.error);
    
    let errorMessage = 'Payment failed. Please try again.';
    if (response.error && response.error.description) {
        errorMessage += ' Reason: ' + response.error.description;
    }
    
    showAlert(errorMessage, 'error');
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const paymentButton = document.getElementById('paymentButton');
    if (paymentButton) {
        paymentButton.addEventListener('click', handlePayment);
    }
});
