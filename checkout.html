const loadingSpinner = document.getElementById('loadingSpinner');

            paymentButton.disabled = true;
            loadingSpinner.classList.add('active');

            try {
                // Get form data
                const formData = getFormData();
                
                // Create order in backend
                const orderData = await createOrder(formData);
                
                console.log('Order created:', orderData);
                
                if (!orderData.success) {
                    throw new Error(orderData.error || 'Failed to create order');
                }

                // Initialize Razorpay payment
                initiateRazorpayPayment(orderData, formData);

            } catch (error) {
                console.error('Payment error:', error);
                showAlert('Payment initialization failed. Please try again. Error: ' + error.message, 'error');
                paymentButton.disabled = false;
                loadingSpinner.classList.remove('active');
            }
        }

        // ===== GET FORM DATA =====
        function getFormData() {
            const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
            const priceData = pricing[totalQuantity] || pricing[3];

            return {
                fullName: document.getElementById('fullName').value.trim(),
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                address1: document.getElementById('address1').value.trim(),
                address2: document.getElementById('address2').value.trim(),
                city: document.getElementById('city').value.trim(),
                state: document.getElementById('state').value,
                pincode: document.getElementById('pincode').value.trim(),
                country: document.getElementById('country').value,
                instructions: document.getElementById('instructions').value.trim(),
                items: cart,
                totalItems: totalQuantity,
                totalAmount: priceData.offer
            };
        }

        // ===== CREATE ORDER IN BACKEND =====
        async function createOrder(formData) {
            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'create_order',
                        ...formData
                    })
                });

                const timestamp = new Date().getTime();
                const random = Math.floor(Math.random() * 10000);
                const orderId = `ORD-${timestamp}-${random}`;

                return {
                    success: true,
                    orderId: orderId,
                    timestamp: new Date().toISOString()
                };
            } catch (error) {
                console.error('Backend error:', error);
                const timestamp = new Date().getTime();
                const random = Math.floor(Math.random() * 10000);
                const orderId = `ORD-${timestamp}-${random}`;

                return {
                    success: true,
                    orderId: orderId,
                    timestamp: new Date().toISOString()
                };
            }
        }

        // ===== INITIATE RAZORPAY PAYMENT =====
        function initiateRazorpayPayment(orderData, formData) {
            console.log('Initiating Razorpay payment...');
            
            const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
            const priceData = pricing[totalQuantity] || pricing[3];

            const options = {
                key: RAZORPAY_KEY_ID,
                amount: priceData.offer * 100,
                currency: 'INR',
                name: 'SORSONE',
                description: `Order for ${totalQuantity} Premium T-Shirt${totalQuantity > 1 ? 's' : ''}`,
                image: 'images/favicon.jpg',
                handler: function(response) {
                    handlePaymentSuccess(response, orderData, formData);
                },
                prefill: {
                    name: formData.fullName,
                    email: formData.email,
                    contact: formData.phone
                },
                notes: {
                    order_id: orderData.orderId,
                    address: `${formData.address1}, ${formData.city}, ${formData.state} - ${formData.pincode}`
                },
                theme: {
                    color: '#D32F2F'
                },
                modal: {
                    ondismiss: function() {
                        const paymentButton = document.getElementById('paymentButton');
                        const loadingSpinner = document.getElementById('loadingSpinner');
                        paymentButton.disabled = false;
                        loadingSpinner.classList.remove('active');
                    }
                }
            };

            try {
                const rzp = new Razorpay(options);
                
                rzp.on('payment.failed', function(response) {
                    handlePaymentFailure(response);
                });

                rzp.open();
                
                setTimeout(() => {
                    document.getElementById('loadingSpinner').classList.remove('active');
                }, 500);
                
            } catch (error) {
                console.error('Razorpay error:', error);
                showAlert('Failed to open payment window. Please try again.', 'error');
                document.getElementById('paymentButton').disabled = false;
                document.getElementById('loadingSpinner').classList.remove('active');
            }
        }

        // ===== HANDLE PAYMENT SUCCESS =====
        async function handlePaymentSuccess(razorpayResponse, orderData, formData) {
            try {
                console.log('Payment successful:', razorpayResponse);
                
                await fetch(BACKEND_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'save_customer',
                        orderId: orderData.orderId,
                        razorpayOrderId: razorpayResponse.razorpay_order_id || '',
                        razorpayPaymentId: razorpayResponse.razorpay_payment_id || '',
                        ...formData
                    })
                });

                await fetch(BACKEND_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'payment_webhook',
                        orderId: orderData.orderId,
                        razorpay_order_id: razorpayResponse.razorpay_order_id || '',
                        razorpay_payment_id: razorpayResponse.razorpay_payment_id || '',
                        razorpay_signature: razorpayResponse.razorpay_signature || '',
                        amount: formData.totalAmount,
                        currency: 'INR',
                        status: 'success',
                        method: 'razorpay',
                        email: formData.email,
                        phone: formData.phone
                    })
                });

                localStorage.removeItem('sorsoneCart');

                window.location.href = `Paymentsuccess.html?order_id=${orderData.orderId}&payment_id=${razorpayResponse.razorpay_payment_id}`;

            } catch (error) {
                console.error('Error saving order:', error);
                localStorage.removeItem('sorsoneCart');
                window.location.href = `Paymentsuccess.html?order_id=${orderData.orderId}&payment_id=${razorpayResponse.razorpay_payment_id || 'N/A'}`;
            }
        }

        // ===== HANDLE PAYMENT FAILURE =====
        function handlePaymentFailure(response) {
            const paymentButton = document.getElementById('paymentButton');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            paymentButton.disabled = false;
            loadingSpinner.classList.remove('active');

            console.error('Payment failed:', response.error);
            
            let errorMessage = 'Payment failed. Please try again.';
            if (response.error.description) {
                errorMessage += ' Error: ' + response.error.description;
            }
            
            showAlert(errorMessage, 'error');
        }
    </script>
</body>
</html>