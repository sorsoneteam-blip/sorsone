// ===== CHECKOUT PAGE JAVASCRIPT - SIMPLIFIED (NO BACKEND) =====

let cart = [];

// Load cart and initialize
document.addEventListener('DOMContentLoaded', function() {
    loadCart();
    displayOrderSummary();
    setupFormValidation();
    setupPlaceOrderButton();
    updateCartCount();
});

function loadCart() {
    const savedCart = localStorage.getItem('sorsoneCart');
    if (savedCart) {
        cart = JSON.parse(savedCart);
    }
    
    // Redirect if cart is empty
    if (cart.length === 0) {
        alert('Your cart is empty! Please add items before checkout.');
        window.location.href = 'index.html#products';
    }
}

function displayOrderSummary() {
    const orderItemsContainer = document.getElementById('orderItems');
    const pricingBreakdown = document.getElementById('pricingBreakdown');
    
    // Display items
    orderItemsContainer.innerHTML = cart.map(item => `
        <div class="order-item">
            <div class="order-item-image">
                <img src="${item.image}" alt="${item.colorName}" onerror="this.src='images/placeholder.jpg'">
            </div>
            <div class="order-item-details">
                <div class="order-item-name">${item.colorName} T-Shirt</div>
                <div class="order-item-meta">Size: ${item.size} â€¢ Qty: ${item.quantity}</div>
            </div>
            <div class="order-item-price">â‚¹${(item.price * item.quantity).toLocaleString('en-IN')}</div>
        </div>
    `).join('');

    // Calculate total
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    const { total, breakdown } = calculateTotal(totalItems);

    // Display breakdown
    pricingBreakdown.innerHTML = `
        <p><strong>Pricing Breakdown:</strong></p>
        ${breakdown}
    `;

    // Update totals
    document.getElementById('subtotal').textContent = `â‚¹${total.toLocaleString('en-IN')}`;
    document.getElementById('total').textContent = `â‚¹${total.toLocaleString('en-IN')}`;
}

function calculateTotal(totalItems) {
    const triplePacks = Math.floor(totalItems / 3);
    const remainder = totalItems % 3;
    
    let total = triplePacks * 799;
    let breakdown = '';
    
    if (triplePacks > 0) {
        breakdown += `<p>â€¢ ${triplePacks} Triple Pack${triplePacks > 1 ? 's' : ''} (${triplePacks * 3} items): â‚¹${(triplePacks * 799).toLocaleString('en-IN')}</p>`;
    }
    
    if (remainder === 2) {
        total += 499;
        breakdown += `<p>â€¢ Double Pack (2 items): â‚¹499</p>`;
    } else if (remainder === 1) {
        total += 299;
        breakdown += `<p>â€¢ Single (1 item): â‚¹299</p>`;
    }
    
    const savings = (totalItems * 1299) - total;
    breakdown += `<p style="color: #28a745; font-weight: 600;">ðŸ’° You save: â‚¹${savings.toLocaleString('en-IN')} (${Math.round((savings / (totalItems * 1299)) * 100)}% OFF)</p>`;
    
    return { total, breakdown };
}

function setupFormValidation() {
    const form = document.getElementById('checkoutForm');
    const inputs = form.querySelectorAll('input[required], select[required]');

    inputs.forEach(input => {
        input.addEventListener('blur', function() {
            validateField(this);
        });

        input.addEventListener('input', function() {
            if (this.parentElement.classList.contains('error')) {
                validateField(this);
            }
        });
    });
}

function validateField(field) {
    const formGroup = field.parentElement;
    
    if (!field.value.trim()) {
        formGroup.classList.add('error');
        return false;
    }

    // Email validation
    if (field.type === 'email') {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(field.value)) {
            formGroup.classList.add('error');
            return false;
        }
    }

    // Phone validation
    if (field.id === 'phone') {
        const phoneRegex = /^[0-9]{10}$/;
        if (!phoneRegex.test(field.value)) {
            formGroup.classList.add('error');
            return false;
        }
    }

    // PIN code validation
    if (field.id === 'pincode') {
        const pincodeRegex = /^[0-9]{6}$/;
        if (!pincodeRegex.test(field.value)) {
            formGroup.classList.add('error');
            return false;
        }
    }

    formGroup.classList.remove('error');
    return true;
}

function validateForm() {
    const form = document.getElementById('checkoutForm');
    const inputs = form.querySelectorAll('input[required], select[required]');
    let isValid = true;

    inputs.forEach(input => {
        if (!validateField(input)) {
            isValid = false;
        }
    });

    return isValid;
}

function setupPlaceOrderButton() {
    const placeOrderBtn = document.getElementById('placeOrderBtn');
    
    placeOrderBtn.addEventListener('click', function() {
        if (!validateForm()) {
            alert('Please fill in all required fields correctly.');
            // Scroll to first error
            const firstError = document.querySelector('.form-group.error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
        }

        initiatePayment();
    });
}

function initiatePayment() {
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    const { total } = calculateTotal(totalItems);

    // Get form data
    const formData = {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        address1: document.getElementById('address1').value,
        address2: document.getElementById('address2').value,
        city: document.getElementById('city').value,
        state: document.getElementById('state').value,
        pincode: document.getElementById('pincode').value,
        notes: document.getElementById('notes').value,
        cart: cart,
        total: total
    };

    // Generate order ID
    const orderId = `SORS${Date.now()}`;

    // Razorpay options - SIMPLIFIED (No backend required)
    const options = {
        key: 'rzp_live_S7dLsK39ZbKgt2', // âš ï¸ REPLACE WITH YOUR ACTUAL RAZORPAY KEY
        amount: total * 100, // Amount in paise
        currency: 'INR',
        name: 'SORSONE',
        description: 'Premium Oversized T-Shirts',
        image: 'images/favicon.jpg',
        order_id: orderId, // Using client-side generated ID
        prefill: {
            name: `${formData.firstName} ${formData.lastName}`,
            email: formData.email,
            contact: formData.phone
        },
        notes: {
            address: `${formData.address1}, ${formData.city}, ${formData.state} - ${formData.pincode}`,
            items: cart.length
        },
        theme: {
            color: '#D32F2F'
        },
        handler: function(response) {
            handlePaymentSuccess(response, formData, orderId);
        },
        modal: {
            ondismiss: function() {
                console.log('Payment cancelled by user');
                alert('Payment was cancelled. Your cart items are still saved.');
            }
        }
    };

    try {
        const razorpay = new Razorpay(options);
        razorpay.on('payment.failed', function(response) {
            handlePaymentFailure(response);
        });
        razorpay.open();
    } catch (error) {
        console.error('Razorpay error:', error);
        alert('Payment initialization failed. Please check your Razorpay key and try again.');
    }
}

function handlePaymentSuccess(response, formData, orderId) {
    console.log('Payment successful:', response);
    
    // Clear cart
    localStorage.removeItem('sorsoneCart');
    
    // Store order details
    const orderData = {
        orderId: orderId,
        paymentId: response.razorpay_payment_id,
        customer: formData,
        timestamp: new Date().toISOString(),
        amount: formData.total
    };
    
    localStorage.setItem('lastOrder', JSON.stringify(orderData));

    // Redirect to success page
    window.location.href = `Paymentsuccess.html?order_id=${orderId}&payment_id=${response.razorpay_payment_id}`;
}

function handlePaymentFailure(response) {
    console.error('Payment failed:', response.error);
    
    let errorMessage = 'Payment failed. ';
    if (response.error.description) {
        errorMessage += response.error.description;
    } else {
        errorMessage += 'Please try again.';
    }
    
    alert(errorMessage);
}

function updateCartCount() {
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    const cartCountElement = document.getElementById('cartCount');
    if (cartCountElement) {
        cartCountElement.textContent = totalItems;
    }
}

// Cart icon click handler
const cartWrapper = document.querySelector('.cart-wrapper');
if (cartWrapper) {
    cartWrapper.addEventListener('click', function() {
        window.location.href = 'add-to-cart.html';
    });
}

console.log('âœ… Checkout page loaded successfully');
